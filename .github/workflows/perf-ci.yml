name: Performance CI - Godrej Home Page

on:
  workflow_dispatch:
  schedule:
    # GitHub cron uses UTC time
    # 09:30 AM IST = 04:00 UTC
    - cron: "0 4 * * *"


jobs:
  performance-test:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download JMeter
        shell: powershell
        run: |
          Invoke-WebRequest https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.zip -OutFile jmeter.zip
          Expand-Archive jmeter.zip C:\Tools -Force
          
      - name: Setup Python deps
        shell: powershell
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Verify secrets are available (safe)
        shell: powershell
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          if ([string]::IsNullOrWhiteSpace($env:SLACK_BOT_TOKEN)) { throw "SLACK_BOT_TOKEN is EMPTY" }
          if ([string]::IsNullOrWhiteSpace($env:SLACK_CHANNEL_ID)) { throw "SLACK_CHANNEL_ID is EMPTY" }
          Write-Host "âœ… Secrets are present (token hidden). Channel=$env:SLACK_CHANNEL_ID"

      - name: Run JMeter + SLA + Slack
        shell: powershell
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          powershell.exe -NoProfile -ExecutionPolicy Bypass -File scripts/run_ci_only_jmeter_sla.ps1
